# tinybpf

Minimal Python library for loading compiled eBPF programs. Uses ctypes bindings to bundled libbpf.

## Install

```bash
uv add tinybpf --index https://gregclermont.github.io/tinybpf
pip install tinybpf --extra-index-url https://gregclermont.github.io/tinybpf
```

Requires Linux 5.8+ (for ring buffers; basic features work on older kernels), libelf, root/CAP_BPF. Wheels: manylinux_2_28 x86_64/aarch64.

## API

```python
import tinybpf

# Load eBPF object file
with tinybpf.load("program.bpf.o") as obj:
    obj.programs  # Dict-like: ProgramCollection
    obj.maps      # Dict-like: MapCollection
    obj.program("name")  # -> BpfProgram
    obj.map("name")      # -> BpfMap

# Open pinned map from bpffs
with tinybpf.open_pinned_map("/sys/fs/bpf/my_map") as map:
    ...

# Optional: use custom libbpf.so (call before other functions)
tinybpf.init("/path/to/libbpf.so")

# BpfProgram - attach methods return BpfLink
prog.attach()                              # Auto-attach by section
prog.attach_kprobe("func", retprobe=False)
prog.attach_kretprobe("func")
prog.attach_tracepoint("category", "name")
prog.attach_raw_tracepoint("name")
prog.attach_uprobe(binary, offset=0, pid=-1, retprobe=False)
prog.attach_uretprobe(binary, offset=0, pid=-1)
prog.attach_xdp(ifindex)  # XDP on network interface (use socket.if_nametoindex)
prog.name, prog.section, prog.type, prog.fd, prog.info

# BpfMap - dict-like interface
map[key] = value    # update
value = map[key]    # lookup (KeyError if missing)
del map[key]        # delete
key in map          # contains
map.lookup(key)     # -> value or None
map.update(key, value, flags=BPF_ANY)  # flags: BPF_ANY|BPF_NOEXIST|BPF_EXIST
map.delete(key)     # -> bool
map.keys(), map.values(), map.items()  # iterators
map.pin("/sys/fs/bpf/path")   # pin to bpffs (object-owned maps only)
map.unpin("/sys/fs/bpf/path") # remove pin
map.name, map.type, map.key_size, map.value_size, map.max_entries, map.fd, map.info

# Keys/values: bytes, int, or ctypes.Structure

# BpfRingBuffer - stream events from BPF_MAP_TYPE_RINGBUF
rb = BpfRingBuffer(map, callback=lambda data: ...)  # callback receives bytes
rb = BpfRingBuffer()  # empty, then rb.add(map, callback) for multi-map
rb.poll(timeout_ms=-1)    # poll and invoke callbacks, returns event count
rb.consume()              # process available events without waiting
await rb.poll_async()     # async polling
async for event in rb     # async iteration (RingBufferEvent with .map_name, .data)
for data in rb.poll_iter(timeout_ms)  # sync iteration (omit callback)

# BpfPerfBuffer - stream events from BPF_MAP_TYPE_PERF_EVENT_ARRAY
pb = BpfPerfBuffer(map, sample_callback=lambda cpu, data: ..., lost_callback=None)
pb.poll(timeout_ms=-1)    # poll and invoke callbacks
pb.consume()              # process available events without waiting

# BpfLink
link.destroy()  # detach program
link.fd

# Versions
tinybpf.version()         # package version
tinybpf.libbpf_version()  # bundled libbpf version

# Types
BpfObject, BpfProgram, BpfMap, BpfLink, BpfRingBuffer, BpfPerfBuffer
BpfMapType, BpfProgType  # IntEnums
MapInfo, ProgramInfo, RingBufferEvent  # dataclasses
BpfError                 # exception with .errno
BPF_ANY, BPF_NOEXIST, BPF_EXIST  # map update flags
```

## Example

```python
import tinybpf
import ctypes

class Event(ctypes.Structure):
    _fields_ = [("pid", ctypes.c_uint32), ("comm", ctypes.c_char * 16)]

with tinybpf.load("trace.bpf.o") as obj:
    link = obj.program("trace_exec").attach_kprobe("do_execve")
    # ... wait for events ...
    for key, event in obj.maps["events"].items():
        print(f"PID {event.pid}: {event.comm.decode()}")
```

## Common Errors

- `BpfError: open failed: No such file or directory` - .bpf.o file not found
- `BpfError: load failed: Operation not permitted` - need root or CAP_BPF
- `BpfError: attach kprobe failed: No such file or directory` - kernel function doesn't exist
- `KeyError` - program/map name not in object, or map key not found

## Links

- GitHub: https://github.com/gregclermont/tinybpf
- Package index: https://gregclermont.github.io/tinybpf
