name: Test Static Build
on: workflow_dispatch
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Test static linking
        run: |
          docker run --rm quay.io/pypa/manylinux_2_28_x86_64 bash -c '
            set -ex

            # Install dev packages (including static libs)
            yum install -y elfutils-libelf-devel zlib-devel zlib-static elfutils-libelf

            # Check if static elfutils package exists
            echo "=== Available static packages ==="
            yum list available | grep -i "static" | grep -iE "(elf|zlib|zstd|lzma|bz)" || echo "none found"
            yum install -y elfutils-devel elfutils-libelf-static 2>/dev/null || echo "static libelf not available"

            # Check static libs
            echo "=== Static libraries ==="
            ls -la /usr/lib64/libelf*.a /usr/lib64/libz*.a 2>/dev/null || echo "Some missing"

            # Check libelf.so deps
            echo "=== libelf.so dependencies ==="
            ldd /usr/lib64/libelf.so.1

            # Build libbpf
            cd /tmp
            curl -sL https://github.com/libbpf/libbpf/archive/refs/tags/v1.4.0.tar.gz | tar xz
            cd libbpf-1.4.0/src

            # Normal build first
            echo "=== Normal build ==="
            make
            ldd libbpf.so.1
            ls -la libbpf.so.1

            # Try static deps if available
            echo "=== Static deps build ==="
            if [ -f /usr/lib64/libelf.a ]; then
              make clean
              make LDFLAGS="-static-libgcc -Wl,-Bstatic -lelf -lz -Wl,-Bdynamic"
              echo "Dependencies after static link:"
              ldd libbpf.so.1
              ls -la libbpf.so.1
            else
              echo "No static libelf.a - trying with just static zlib"
              make clean
              # Link zlib statically, libelf dynamically
              make LDFLAGS="-Wl,-Bstatic -lz -Wl,-Bdynamic -lelf"
              echo "Dependencies with static zlib:"
              ldd libbpf.so.1
              ls -la libbpf.so.1
            fi
          '
