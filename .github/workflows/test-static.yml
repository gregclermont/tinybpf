name: Test Static Build
on: workflow_dispatch
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Test static linking
        run: |
          docker run --rm quay.io/pypa/manylinux_2_28_x86_64 bash -c '
            set -ex

            # Install dev packages (including static libs from powertools)
            yum install -y elfutils-libelf-devel zlib-devel zlib-static
            yum install -y --enablerepo=powertools elfutils-devel-static || echo "static elfutils not in powertools"

            # Check static libs
            echo "=== Static libraries ==="
            ls -la /usr/lib64/libelf.a /usr/lib64/libz.a 2>/dev/null || echo "Some missing"

            # Check libelf.so deps
            echo "=== libelf.so dependencies ==="
            ldd /usr/lib64/libelf.so.1

            # Build libbpf
            cd /tmp
            curl -sL https://github.com/libbpf/libbpf/archive/refs/tags/v1.4.0.tar.gz | tar xz
            cd libbpf-1.4.0/src

            # Normal build first
            echo "=== Normal build ==="
            make
            ldd libbpf.so.1
            ls -la libbpf.so.1

            # Try static deps if available
            echo "=== Static deps build ==="
            if [ -f /usr/lib64/libelf.a ] && [ -f /usr/lib64/libz.a ]; then
              make clean
              # Use NO_PKG_CONFIG and link .a files directly
              make NO_PKG_CONFIG=1 EXTRA_LDFLAGS="/usr/lib64/libelf.a /usr/lib64/libz.a"
              echo "Dependencies after static link:"
              ldd libbpf.so.1
              ls -la libbpf.so.1
              ls -la libbpf.so.1.4.0
            else
              echo "Static libs not available:"
              ls -la /usr/lib64/libelf.a /usr/lib64/libz.a 2>&1 || true
            fi
          '
