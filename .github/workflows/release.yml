name: Release

on:
  workflow_dispatch:

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Get version from __init__.py
        id: get-version
        run: |
          version=$(python3 << 'EOF'
          import re
          with open('src/tinybpf/__init__.py') as f:
              content = f.read()
          match = re.search(r'__version__\s*=\s*["\'](.+?)["\']', content)
          print(match.group(1))
          EOF
          )
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Detected version: $version"

      - name: Check version format
        run: |
          version="${{ steps.get-version.outputs.version }}"
          if ! echo "$version" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
            echo "Error: Invalid version format: $version"
            exit 1
          fi

      - name: Check release doesn't exist
        run: |
          version="${{ steps.get-version.outputs.version }}"
          if gh release view "v$version" &>/dev/null; then
            echo "Error: Release v$version already exists"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  build-ebpf:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build test eBPF programs
        run: make compile

      - name: Upload eBPF objects
        uses: actions/upload-artifact@v4
        with:
          name: test-ebpf-objects
          path: tests/bpf/*.bpf.o

  build:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, aarch64]

    steps:
      - uses: actions/checkout@v4

      - name: Download libbpf
        run: |
          gh release download libbpf-v$(cat src/tinybpf/.libbpf-version) \
            --pattern "libbpf-${{ matrix.arch }}.tar.gz"
          mkdir -p src/tinybpf/_libbpf
          tar xzf libbpf-${{ matrix.arch }}.tar.gz -C src/tinybpf/_libbpf/
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build wheel
        run: |
          pip install setuptools wheel
          pip wheel . --no-build-isolation --wheel-dir dist/

      - name: Rename wheel for platform
        run: |
          cd dist
          for f in *.whl; do
            newname=$(echo "$f" | sed 's/-py3-none-any\.whl/-py3-none-manylinux_2_28_${{ matrix.arch }}.whl/')
            mv "$f" "$newname"
          done

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.arch }}
          path: dist/*.whl

  build-sdist:
    needs: prepare
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build sdist
        run: |
          pip install build
          python -m build --sdist

      - name: Upload sdist artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  test-wheel-x86_64:
    needs: [build, build-ebpf]
    uses: ./.github/workflows/_test-wheel.yml
    with:
      python-versions: '["3.10", "3.11", "3.12"]'
      arch: x86_64
      wheel-artifact: wheel-x86_64

  test-wheel-aarch64:
    needs: [build, build-ebpf]
    uses: ./.github/workflows/_test-wheel.yml
    with:
      python-versions: '["3.10", "3.11", "3.12"]'
      arch: aarch64
      wheel-artifact: wheel-aarch64

  release:
    needs: [prepare, build, build-sdist, test-wheel-x86_64, test-wheel-aarch64]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: wheel-*
          merge-multiple: true

      - name: Download sdist artifact
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: v${{ needs.prepare.outputs.version }}
          body: |
            Install with:
            ```
            pip install -i https://gregclermont.github.io/tinybpf/ tinybpf
            ```

            Or with uv inline script metadata:
            ```python
            # /// script
            # dependencies = ["tinybpf"]
            # [tool.uv]
            # index-url = "https://gregclermont.github.io/tinybpf/"
            # ///
            ```
          files: |
            dist/*.whl
            dist/*.tar.gz

  update-index:
    needs: [prepare, release]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Copy static files from main branch
        run: |
          git show origin/main:llms.txt > llms.txt
          git show origin/main:gh-pages/index.html > index.html

      - name: Generate package index
        run: |
          mkdir -p tinybpf
          cat > tinybpf/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head><title>tinybpf</title></head>
          <body>
          HTMLEOF

          # Fetch all wheel and sdist URLs from releases and add to index
          gh release list --json tagName --jq '.[].tagName' | grep '^v' | while read tag; do
            gh release view "$tag" --json assets --jq '.assets[].url' | grep -E '\.(whl|tar\.gz)$' | while read url; do
              filename=$(basename "$url")
              echo "<a href=\"$url\">$filename</a>" >> tinybpf/index.html
            done
          done

          cat >> tinybpf/index.html << 'HTMLEOF'
          </body>
          </html>
          HTMLEOF
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Push to gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.html llms.txt tinybpf/index.html
          git commit -m "Update package index and static files for v${{ needs.prepare.outputs.version }}" || exit 0
          git push
