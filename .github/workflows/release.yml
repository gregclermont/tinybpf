name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, aarch64]

    steps:
      - uses: actions/checkout@v4

      - name: Download libbpf
        run: |
          gh release download libbpf-v$(cat src/tinybpf/.libbpf-version) \
            --pattern "libbpf-${{ matrix.arch }}.tar.gz"
          mkdir -p src/tinybpf/_libbpf
          tar xzf libbpf-${{ matrix.arch }}.tar.gz -C src/tinybpf/_libbpf/
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Set version
        run: |
          python3 << 'EOF'
          import re
          import sys

          version = "${{ inputs.version }}"

          # Validate version format (basic semver)
          if not re.match(r'^\d+\.\d+\.\d+(-[\w.]+)?$', version):
              print(f"Error: Invalid version format: {version}")
              sys.exit(1)

          with open('pyproject.toml', 'r') as f:
              content = f.read()

          # Match version = "..." with any quote style
          new_content, count = re.subn(
              r'^version\s*=\s*["\'].*?["\']',
              f'version = "{version}"',
              content,
              flags=re.MULTILINE
          )

          if count == 0:
              print("Error: Could not find version field in pyproject.toml")
              sys.exit(1)

          with open('pyproject.toml', 'w') as f:
              f.write(new_content)

          print(f"Updated version to {version}")
          EOF

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build wheel
        run: |
          pip install setuptools wheel
          pip wheel . --no-build-isolation --wheel-dir dist/

      - name: Rename wheel for platform
        run: |
          cd dist
          for f in *.whl; do
            newname=$(echo "$f" | sed 's/-py3-none-any\.whl/-py3-none-manylinux_2_28_${{ matrix.arch }}.whl/')
            mv "$f" "$newname"
          done

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.arch }}
          path: dist/*.whl

  test-wheel-x86_64:
    needs: build
    uses: ./.github/workflows/_test-wheel.yml
    with:
      python-versions: '["3.10", "3.11", "3.12"]'
      arch: x86_64
      wheel-artifact: wheel-x86_64

  test-wheel-aarch64:
    needs: build
    uses: ./.github/workflows/_test-wheel.yml
    with:
      python-versions: '["3.10", "3.11", "3.12"]'
      arch: aarch64
      wheel-artifact: wheel-aarch64

  release:
    needs: [build, test-wheel-x86_64, test-wheel-aarch64]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: wheels
          pattern: wheel-*
          merge-multiple: true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          body: |
            Install with:
            ```
            pip install -i https://gregclermont.github.io/tinybpf/ tinybpf
            ```

            Or with uv inline script metadata:
            ```python
            # /// script
            # dependencies = ["tinybpf"]
            # [tool.uv]
            # index-url = "https://gregclermont.github.io/tinybpf/"
            # ///
            ```
          files: wheels/*.whl

  update-index:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Copy static files from main branch
        run: |
          git show origin/main:llms.txt > llms.txt
          git show origin/main:gh-pages/index.html > index.html

      - name: Generate package index
        run: |
          mkdir -p tinybpf
          cat > tinybpf/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head><title>tinybpf</title></head>
          <body>
          HTMLEOF

          # Fetch all wheel URLs from releases and add to index
          gh release list --json tagName --jq '.[].tagName' | grep '^v' | while read tag; do
            gh release view "$tag" --json assets --jq '.assets[].url' | grep '\.whl$' | while read url; do
              filename=$(basename "$url")
              echo "<a href=\"$url\">$filename</a>" >> tinybpf/index.html
            done
          done

          cat >> tinybpf/index.html << 'HTMLEOF'
          </body>
          </html>
          HTMLEOF
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Push to gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.html llms.txt tinybpf/index.html
          git commit -m "Update package index and static files for v${{ inputs.version }}" || exit 0
          git push
