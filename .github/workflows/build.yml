name: Build Wheels

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-libbpf:
    name: Build libbpf for ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64]  # Start with x86_64 only for faster CI

    steps:
      - uses: actions/checkout@v4

      - name: Build libbpf in manylinux container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            quay.io/pypa/manylinux_2_28_x86_64 \
            bash -c '
              set -ex

              # Install build dependencies
              yum install -y elfutils-libelf-devel zlib-devel git

              # Clone and build libbpf
              git clone --depth 1 --branch v1.4.0 https://github.com/libbpf/libbpf.git /tmp/libbpf
              cd /tmp/libbpf/src

              # Build shared library
              make -j$(nproc)

              # Copy to workspace
              mkdir -p /workspace/src/tinybpf/_libbpf
              cp libbpf.so.1.4.0 /workspace/src/tinybpf/_libbpf/
              cd /workspace/src/tinybpf/_libbpf
              ln -sf libbpf.so.1.4.0 libbpf.so.1
              ln -sf libbpf.so.1 libbpf.so

              # Verify
              ls -la /workspace/src/tinybpf/_libbpf/
            '

      - name: Upload libbpf artifact
        uses: actions/upload-artifact@v4
        with:
          name: libbpf-${{ matrix.arch }}
          path: src/tinybpf/_libbpf/libbpf.so*

  build-wheels:
    name: Build wheels
    needs: build-libbpf
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download libbpf artifact
        uses: actions/download-artifact@v4
        with:
          name: libbpf-x86_64
          path: src/tinybpf/_libbpf/

      - name: Verify libbpf files
        run: |
          ls -la src/tinybpf/_libbpf/
          file src/tinybpf/_libbpf/libbpf.so* || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build wheel
        run: |
          pip install build wheel
          python -m build --wheel
          # Rename to manylinux tag (we bundle manylinux-compatible libbpf.so)
          cd dist
          for whl in *.whl; do
            if [[ $whl == *linux_x86_64* ]]; then
              newname="${whl/linux_x86_64/manylinux_2_28_x86_64}"
              mv "$whl" "$newname"
            fi
          done
          ls -la

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-x86_64
          path: ./dist/*.whl

  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build sdist
        run: |
          pip install build
          python -m build --sdist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  test-wheel:
    name: Test wheel installation
    needs: build-wheels
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: wheels-x86_64
          path: ./dist/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install wheel and run tests
        run: |
          pip install ./dist/*.whl pytest
          # Run tests from a temp directory to ensure we test the installed wheel, not source
          mkdir /tmp/test-wheel
          cp -r tests /tmp/test-wheel/
          cd /tmp/test-wheel
          pytest tests/ -v --ignore=tests/test_integration.py

  publish:
    name: Publish to PyPI
    needs: [build-wheels, build-sdist, test-wheel]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    permissions:
      id-token: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true

      - name: List distribution files
        run: ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
